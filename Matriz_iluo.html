
<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RQ-0705-FOP Ficha de Talento</title>
  <link rel="icon" type="image/png" href="Isovolta.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #004990;
      --primary-light: #006ad1;
      --primary-dark: #003366;
      --secondary: #00a651;
      --accent: #2bace2;
      --light: #f4f7fb;
      --light-gray: #e9ecef;
      --dark: #333;
      --danger: #dc3545;
      --warning: #ffc107;
      --success: #28a745;
      --border-radius: 12px;
      --box-shadow: 0 1px 4px rgba(0, 73, 144, 0.1);
      --transition: all 0.2s ease;

      /* Compactación fina */
      --base-font: 13px;
      --table-font: 9.5px;
      --row-h: 24px;
      --th-h: 26px;
      --input-h: 22px;
      --btn-h: 26px;
      --gap: 8px;

      /* Zoom UI */
      --ui-zoom: 1; /* 1 = 100% */
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body { height: 100%; overflow: hidden; } /* <- bloquea scroll global */
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--light);
      color: var(--dark);
      line-height: 1.3;
      font-size: var(--base-font);
      display: flex;
      flex-direction: column;
      zoom: var(--ui-zoom); /* escala visual interna */
    }

    /* Header compacto */
    header {
      position: relative;                /* para posicionar la barra de zoom dentro */
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px 10px;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0, 73, 144, 0.1);
      border-bottom: 2px solid var(--primary);
    }
    header h1 {
      color: var(--primary);
      margin: 0;
      font-size: 1.05rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    header h1 i { font-size: .95rem; }
    header img { height: 28px; max-width: 120px; }

    /* Barra de zoom centrada dentro del header */
    .zoom-toolbar{
      position: absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      display: flex; gap: 6px; z-index: 2;
      background:#fff; border:1px solid #d7dfe8; border-radius:8px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      padding: 6px 8px; align-items: center; font-size:12px;
    }
    .zoom-toolbar button{
      height: 26px; padding: 0 10px; border-radius:6px; border:1px solid #cfd6df;
      background:#f7faff; cursor:pointer; font-weight:600;
    }
    .zoom-toolbar button:hover{ background:#eef5ff; }
    .zoom-toolbar .val{ min-width: 40px; text-align:center; font-weight:700; }

    /* Layout principal compacto */
    .main-container {
      flex: 1;
      display: flex;
      gap: var(--gap);
      padding: var(--gap);
      height: calc(100vh - 56px); /* ocupa el resto de la pantalla bajo el header */
      min-height: 480px;
      min-width: 0; /* importante para flex + overflow */
    }
    .content-left {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;       /* permite que el #matriz haga scroll horizontal */
      overflow: hidden;   /* evita scroll propio */
    }

    /* Panel de búsqueda */
    .panel-busqueda {
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 6px 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      flex-shrink: 0; /* no colapsa */
    }
    .panel-busqueda .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      flex: 1;
      min-width: 0;
    }
    .panel-busqueda select,
    .panel-busqueda input {
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #cfd6df;
      padding: 3px 6px;
      background: #f7faff;
      min-width: 140px;
      height: var(--btn-h);
    }
    .btn {
      background: var(--primary);
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      padding: 0 10px;
      border-radius: 5px;
      font-size: 11px;
      height: var(--btn-h);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn:hover { background: var(--primary-light); }

    .panel-busqueda .alerta {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 5px 8px;
      font-size: 12px;
      border-radius: 4px;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }

    /* Datos del operador */
    .datos-operador {
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 8px 10px;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }
    .datos-operador::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 3px; height: 100%;
      background: var(--primary);
    }
    .datos-operador h2 {
      font-size: .95rem;
      color: var(--primary-dark);
      margin: 0;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Tabla ultra compacta con encabezado fijo */
    .tabla-matriz {
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;      /* oculta desbordes visuales */
      flex: 1;               /* ocupa todo el alto restante */
      display: flex;
      flex-direction: column;
      min-height: 0;         /* permite que el hijo flex (#matriz) se contraiga */
    }
    .filtros-tabla {
      padding: 4px 6px;
      background: var(--light-gray);
      border-bottom: 1px solid #d7dfe8;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      flex-shrink: 0;
    }
    .filtros-tabla input {
      padding: 2px 6px;
      border: 1px solid #cfd6df;
      border-radius: 4px;
      font-size: 11px;
      height: 24px;
      flex: 1;
      min-width: 120px;
      background: #ffffff;
    }

    /* El área que hace scroll (vertical y horizontal) */
    #matriz {
      flex: 1;                 /* ocupa todo lo disponible */
      min-height: 0;
      overflow: auto;          /* el scroll vive aquí */
      -webkit-overflow-scrolling: touch;
    }

    table {
      font-size: var(--table-font);
      border-collapse: collapse;
      width: 100%;
      min-width: 860px;
      background: white;
    }
    th {
      background-color: #0b4f93; /* un poco más oscuro para contraste al hacer sticky */
      color: #fff;
      position: sticky;
      top: 0;           /* se pega al borde superior del contenedor con scroll (#matriz) */
      z-index: 5;
      padding: 4px 6px;
      text-align: left;
      font-weight: 700;
      border-right: 1px solid rgba(255,255,255,0.12);
      white-space: nowrap;
      height: var(--th-h);
    }
    th::after {
      content: "";
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 2px;
      box-shadow: 0 2px 3px rgba(0,0,0,.08);
      pointer-events: none;
    }
    th:last-child { border-right: none; }

    td {
      padding: 2px 6px;
      border-bottom: 1px solid #eef2f6;
      vertical-align: middle;
      height: var(--row-h);
      white-space: nowrap;
    }
    tr:nth-child(even) { background: #f8fafc; }

    td input[type="number"],
    td input[type="date"] {
      width: 100%;
      padding: 0 4px;
      border: 1px solid #cfd6df;
      border-radius: 4px;
      font-size: 10.5px;
      height: var(--input-h);
      background: #ffffff;
    }

    /* Nivel ILUO compacto */
    .nivel-cell {
      text-align: center;
      font-weight: 700;
      border-radius: 4px;
      padding: 0 4px;
      min-width: 28px;
      font-size: 10px;
      line-height: calc(var(--input-h) - 4px);
      border: 1px solid #e6ebf2;
      background: #fff;
    }
    .nivel-NA { background: #f0e6f5; color: #8e44ad; border-color:#ead9f2; }
    .nivel-I  { background: #ffeaea; color: #e74c3c; border-color:#ffd0d0; }
    .nivel-L  { background: #e8f4fd; color: #3498db; border-color:#d2e9fb; }
    .nivel-U  { background: #eafaf1; color: #27ae60; border-color:#d6f4e3; }
    .nivel-O  { background: #fef9e7; color: #f39c12; border-color:#f8e9b7; }

    /* Panel derecho compacto */
    .panel-right {
      width: 240px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex-shrink: 0;
      min-height: 0;            /* junto con overflow, evita empujar la página */
      overflow: auto;           /* si se pasara de alto, scrollea este panel */
    }
    .card {
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 8px;
    }
    .card-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      color: var(--primary);
      font-weight: 700;
      font-size: 11px;
    }

    .foto-tarjeta { text-align: center; }
    #fotoOperador {
      max-width: 150px;
      margin: 0 auto 6px auto;
      border-radius: 4px;
      border: 1px solid #e3e3e3;
      display: none;
    }
    #nombreFotoActual { font-size: 10px; color: #666; margin-bottom: 6px; }

    /* Resumen compacto */
    .resumen-compacto { font-size: 10px; line-height: 1.15; }
    .resumen-linea {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
      padding: 1px 0;
    }
    .resumen-categoria { flex: 1; text-align: left; }
    .resumen-porcentaje { width: 44px; text-align: right; font-weight: 700; }
    .resumen-total {
      margin-top: 6px;
      padding: 6px;
      background: #f0f5ff;
      border-radius: 6px;
      font-size: 11px;
      text-align: center;
      font-weight: 800;
      border: 1px solid #d0e0ff;
    }

    .backup-card { border: 1px dashed #9cb5ce; }
    .backup-actions { display: flex; flex-direction: column; gap: 4px; margin-top: 4px; }
    .backup-actions .btn { width: 100%; justify-content: center; font-size: 10.5px; height: 24px; }

    /* Leyenda ILUO */
    #leyendaILUO { font-size: 10px; line-height: 1.15; }
    .leyenda-item { margin-bottom: 4px; padding: 4px; border-radius: 4px; }
    .leyenda-item strong {
      display: inline-block; width: 18px; text-align: center;
      margin-right: 4px; padding: 1px 3px; border-radius: 3px; font-size: 9.5px;
    }
    .leyenda-na { background: #f8f5fb; } .leyenda-na strong { background: #f0e6f5; color: #8e44ad; }
    .leyenda-i  { background: #fff5f5; } .leyenda-i  strong { background: #ffeaea; color: #e74c3c; }
    .leyenda-l  { background: #f5f9ff; } .leyenda-l  strong { background: #e8f4fd; color: #3498db; }
    .leyenda-u  { background: #f5fff7; } .leyenda-u  strong { background: #eafaf1; color: #27ae60; }
    .leyenda-o  { background: #fffef5; } .leyenda-o  strong { background: #fef9e7; color: #f39c12; }

    /* Footer */
    footer {
      background: var(--primary-dark);
      color: #fff;
      text-align: center;
      padding: 4px 0;
      font-size: 10px;
      flex-shrink: 0;
    }

    /* Scrollbars delgados */
    #matriz::-webkit-scrollbar { height: 8px; width: 8px; }
    #matriz::-webkit-scrollbar-track { background: #f1f3f6; border-radius: 6px; }
    #matriz::-webkit-scrollbar-thumb { background: #c4ccd6; border-radius: 6px; }
    #matriz::-webkit-scrollbar-thumb:hover { background: #aeb7c3; }

    /* Notificaciones */
    .notification {
      position: fixed;
      top: 10px; right: 10px;
      padding: 6px 10px;
      border-radius: var(--border-radius);
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex; align-items: center; gap: 6px;
      z-index: 1000;
      transform: translateX(150%);
      transition: transform 0.3s ease;
      font-size: 11px;
    }
    .notification.show { transform: translateX(0); }
    .notification.success { border-left: 2px solid #28a745; }
    .notification.error { border-left: 2px solid #dc3545; }

    /* Responsivo */
    @media (max-width: 1024px) {
      .main-container { flex-direction: column; gap: 6px; height: calc(100vh - 56px); }
      .panel-right { width: 100%; flex-direction: row; flex-wrap: wrap; gap: 6px; }
      .panel-right .card { flex: 1; min-width: 220px; }
      .zoom-toolbar{ left: 50%; transform: translateX(-50%); top: 6px; }
    }
    @media (max-width: 768px) {
      header { padding: 6px 10px 42px; } /* deja aire para la barra de zoom si se apila */
      header h1 { font-size: 1rem; }
      .main-container { padding: 6px; }
      .panel-busqueda .filtros { flex-direction: column; width: 100%; }
      .panel-busqueda select, .panel-busqueda input { width: 100%; }
      .panel-right { flex-direction: column; }
      .panel-right .card { min-width: 100%; }
      .zoom-toolbar{ top: 34px; }
    }
  </style>
</head>
<body>

<header>
  <h1><i class="fas fa-user-tie"></i> RQ-0705-FOP Ficha de talento</h1>

  <!-- Barra de zoom centrada en el header (NO flotante) -->
  <div class="zoom-toolbar" aria-label="Controles de zoom de la aplicación">
    <button type="button" onclick="ajustarZoom(-0.05)">−</button>
    <span class="val" id="zoomVal">100%</span>
    <button type="button" onclick="ajustarZoom(+0.05)">+</button>
    <button type="button" onclick="setZoom(1.00)" title="Restablecer a 100%">100</button>
    <button type="button" onclick="setZoom(1.10)" title="Vista cómoda">110</button>
    <button type="button" onclick="setZoom(1.20)" title="Vista grande">120</button>
  </div>

  <img alt="Isovolta Logo" src="https://www.isovolta.com/logo_isovolta.png"/>
</header>

<div class="main-container">
  <div class="content-left">
    <div class="panel-busqueda">
      <div class="filtros">
        <select id="areaFiltro" onchange="filtrarOperadoresPorArea()">
          <option value="">-- Área --</option>
        </select>
        <select id="operadoresGuardados" onchange="cargarOperador()">
          <option value="">-- Operador --</option>
        </select>
        <button class="btn" onclick="guardarDatos()">
          <i class="fas fa-save"></i> Guardar
        </button>
        <button class="btn" onclick="calcularResumenCategorias()">
          <i class="fas fa-calculator"></i> Calcular
        </button>
      </div>
     
    </div>

    <div class="datos-operador" id="infoOperador">
      <h2><i class="fas fa-id-card"></i> Información del Operador</h2>
      <p style="font-size: 11px; margin-top: 3px;">Seleccione un operador para ver su información</p>
    </div>

    <div class="tabla-matriz">
      <div class="filtros-tabla">
        <input type="text" id="filtroCategoria" placeholder="Categoría...">
        <input type="text" id="filtroCodigo" placeholder="Código...">
        <input type="text" id="filtroDocumento" placeholder="Documento...">
        <button class="btn" onclick="aplicarFiltrosMatriz()">
          <i class="fas fa-filter"></i> Filtrar
        </button>
      </div>

      <!-- Solo esta área scrollea -->
      <div id="matriz">
        <p style="padding: 14px; text-align: center; color: #666; font-size: 11px;">
          Cargue un operador para ver su matriz de competencias
        </p>
      </div>
    </div>
  </div>

  <div class="panel-right">
    <div class="card foto-tarjeta">
      <div class="card-header">
        <i class="fas fa-camera"></i> Foto
      </div>
      <img id="fotoOperador" src="" alt="Foto del operador"/>
      <div id="nombreFotoActual">Sin foto cargada</div>
      <input type="file" id="inputFoto" accept="image/*" onchange="cargarFotoBase64(event)" style="display: none;">
      <button class="btn" onclick="document.getElementById('inputFoto').click()" style="width: 100%;">
        <i class="fas fa-upload"></i> Cargar Foto
      </button>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="fas fa-chart-bar"></i> Resumen
      </div>
      <div id="promediosPorCategoria" class="resumen-compacto">
        <p style="text-align: center; color: #666; font-style: italic;">
          Calcule para ver resultados
        </p>
      </div>
      <div id="resultadoFinal" class="resumen-total"></div>
    </div>

    <div class="card backup-card">
      <div class="card-header">
        <i class="fas fa-database"></i> Respaldo
      </div>
      <div class="backup-actions">
        <button class="btn" onclick="exportarDatos()">
          <i class="fas fa-download"></i> Exportar
        </button>
        <div style="position: relative;">
          <input type="file" id="importFile" accept=".json" onchange="importarDatos(event)" style="display: none;">
          <button class="btn" onclick="document.getElementById('importFile').click()" style="width: 100%;">
            <i class="fas fa-upload"></i> Importar
          </button>
        </div>
      </div>
    </div>

    <div class="card" id="leyendaILUO">
      <div class="card-header">
        <i class="fas fa-info-circle"></i> Referencias ILUO
      </div>
      <div class="leyenda-item leyenda-na">
        <strong>N/A</strong> Entrenamiento (Cat. E): Personal sin conocimiento, no puede operar autónomamente.
      </div>
      <div class="leyenda-item leyenda-i">
        <strong>I</strong> Semicompetente (Cat. D): Aplica tareas con supervisión. Calcula, resuelve y aplica.
      </div>
      <div class="leyenda-item leyenda-l">
        <strong>L</strong> Competente (Cat. C): Opera tareas sin supervisión. Clasifica, interpreta, sintetiza.
      </div>
      <div class="leyenda-item leyenda-u">
        <strong>U</strong> Experto (Cat. B): Realiza tareas y las supervisa. Propone, mejora, diseña.
      </div>
      <div class="leyenda-item leyenda-o">
        <strong>O</strong> Maestro (Cat. A): Realiza, supervisa y enseña. Evalúa, optimiza y forma a otros.
      </div>
    </div>
  </div>
</div>



<!-- Notificación -->
<div id="notification" class="notification">
  <i class="fas fa-check-circle"></i>
  <span id="notificationText">Operación completada</span>
</div>

<script>
/* === Tu lógica original, intacta === */
const DB_NAME = 'ILUO_DB';
const DB_VERSION = 1;
const STORE_NAME = 'respaldo';
const RUTAS_EXAMENES_KEY = 'rutasExamenesV2';

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'clave' });
      }
    };
    request.onsuccess = () => resolve(request.result);
    request.onerror = (event) => reject(event.target.error);
  });
}

async function guardarEnIndexedDB(clave, valor) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    store.put({ clave, valor });
    tx.oncomplete = () => resolve();
    tx.onerror = (e) => reject(e.target.error);
  });
}

async function leerDeIndexedDB(clave) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(clave);
    req.onsuccess = () => resolve(req.result ? req.result.valor : null);
    req.onerror = (e) => reject(e.target.error);
  });
}

async function migrarLocalStorageAIndexedDB() {
  const claves = ["matrizILUO", "documentosILUO", "indiceDocumentosExtra", "documentosAdministrador", "indiceIATF","examenesILUO"];
  for (let clave of claves) {
    const val = localStorage.getItem(clave);
    if (val && !(await leerDeIndexedDB(clave))) {
      await guardarEnIndexedDB(clave, JSON.parse(val));
    }
  }
}

// ----- Globales -----
let operadorActual = null;
let operadores = [];
let documentos = [];
let indiceDocumentosExtra = [];
let documentosAdministrador = [];
let indiceIATF = [];
let examenesILUO = [];
let rutasExamenes = {};

// ----- Inicialización -----
async function inicializar() {
  await migrarLocalStorageAIndexedDB();
  operadores = await leerDeIndexedDB("matrizILUO") || [];
  documentos = await leerDeIndexedDB("documentosILUO") || [];
  indiceDocumentosExtra = await leerDeIndexedDB("indiceDocumentosExtra") || [];
  documentosAdministrador = await leerDeIndexedDB("documentosAdministrador") || [];
  indiceIATF = await leerDeIndexedDB("indiceIATF") || [];
  examenesILUO = await leerDeIndexedDB("examenesILUO") || [];
  rutasExamenes = await leerDeIndexedDB(RUTAS_EXAMENES_KEY) || {};
  cargarListaOperadores();
  showNotification('Sistema cargado correctamente', 'success');
}
document.addEventListener("DOMContentLoaded", inicializar);

// ----- Funciones principales -----
function calcularNivel(p) {
  if (p >= 95) return "O";
  if (p >= 90) return "U";
  if (p >= 80) return "L";
  if (p >= 70) return "I";
  if (p >= 2) return "NA";
  return "NA";
}

function renderizarMatriz() {
  document.getElementById("infoOperador").innerHTML =
    `<h2><i class="fas fa-id-card"></i> Empleado: ${operadorActual.numero} | ${operadorActual.nombre} | Puesto: ${operadorActual.puesto} | Área: ${operadorActual.area}</h2>`;

  const docs = documentos.filter(d =>
    d.puesto && operadorActual.puesto &&
    d.puesto.toLowerCase().trim() === operadorActual.puesto.toLowerCase().trim()
  );

  let html = '<table><thead><tr><th>Código</th><th>Documento</th><th>Tipo de Categoría</th><th>Revisión</th><th>Capacitador</th><th>Calificación</th><th>Fecha de Entrenamiento</th><th>Nivel ILUO</th></tr></thead><tbody>';

  docs.forEach((doc, i) => {
    const id = `doc_${i}`;
    html += `<tr>
      <td class="codigo">${doc.codigo || ''}</td>
      <td class="documento">${doc.documento}</td>
      <td>${doc.tipoCategoria || ""}</td>
      <td>${doc.revision || ''}</td>
      <td>${doc.capacitador || ''}</td>
      <td><input type="number" id="cal_${id}" min="0" max="100" onchange="actualizarNivel('${id}'); calcularResumenCategorias()"></td>
      <td><input type="date" id="fecha_${id}" placeholder="dd/mm/aaaa"></td>
      <td><div id="nivel_${id}" class="nivel-cell"></div></td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById("matriz").innerHTML = html;
}

function actualizarNivel(id) {
  const val = parseFloat(document.getElementById(`cal_${id}`).value);
  const elemento = document.getElementById(`nivel_${id}`);
  const nivel = calcularNivel(val);
  elemento.textContent = nivel || '';
  elemento.className = 'nivel-cell';
  if (nivel) elemento.classList.add('nivel-' + nivel);
}

async function guardarDatos() {
  if (!operadorActual) {
    showNotification('No hay operador activo', 'error');
    return;
  }

  operadorActual.documentacion = [];

  const docs = documentos.filter(d =>
    d.puesto && operadorActual.puesto &&
    d.puesto.toLowerCase() === operadorActual.puesto.toLowerCase()
  );

  docs.forEach((doc, i) => {
    const id = `doc_${i}`;
    operadorActual.documentacion.push({
      nombre: doc.documento,
      codigo: doc.codigo,
      revision: doc.revision,
      capacitador: doc.capacitador,
      calificacion: document.getElementById(`cal_${id}`).value,
      fecha: document.getElementById(`fecha_${id}`).value,
      nivel: document.getElementById(`nivel_${id}`).textContent,
    });
  });

  const lista = await leerDeIndexedDB("matrizILUO") || [];
  const idx = lista.findIndex(op => op.numero === operadorActual.numero);
  if (idx >= 0) lista[idx] = operadorActual;
  else lista.push(operadorActual);
  await guardarEnIndexedDB("matrizILUO", lista);

  showNotification('Datos guardados correctamente', 'success');
}

async function cargarListaOperadores() {
  operadores = await leerDeIndexedDB("matrizILUO") || [];
  const areas = [...new Set(operadores.map(op => op.area))].sort();
  const areaSelect = document.getElementById("areaFiltro");
  areaSelect.innerHTML = '<option value="">-- Área --</option>';
  areas.forEach(area => {
    const opt = document.createElement("option");
    opt.value = area;
    opt.textContent = area;
    areaSelect.appendChild(opt);
  });
  actualizarListaOperadores(operadores);
}

function actualizarListaOperadores(lista) {
  const select = document.getElementById("operadoresGuardados");
  select.innerHTML = '<option value="">-- Operador --</option>';
  lista.forEach(op => {
    const opt = document.createElement("option");
    opt.value = op.numero;
    opt.textContent = op.nombre;
    select.appendChild(opt);
  });
}

async function filtrarOperadoresPorArea() {
  const area = document.getElementById("areaFiltro").value;
  operadores = await leerDeIndexedDB("matrizILUO") || [];
  const filtrados = area ? operadores.filter(op => op.area === area) : operadores;
  actualizarListaOperadores(filtrados);
}

async function cargarFotoBase64(event) {
  const file = event.target.files[0];
  if (!file || !operadorActual) return;
  const reader = new FileReader();
  reader.onload = async function(e) {
    operadorActual.foto = e.target.result;
    let personas = await leerDeIndexedDB("matrizILUO") || [];
    const idx = personas.findIndex(p => p.numero === operadorActual.numero);
    if (idx >= 0) personas[idx].foto = operadorActual.foto;
    await guardarEnIndexedDB("matrizILUO", personas);
    mostrarFotoBase64();
    showNotification('Foto cargada correctamente', 'success');
  };
  reader.readAsDataURL(file);
}

function mostrarFotoBase64() {
  const img = document.getElementById("fotoOperador");
  const lbl = document.getElementById("nombreFotoActual");
  if (operadorActual && operadorActual.foto && operadorActual.foto.startsWith("data:image")) {
    img.src = operadorActual.foto;
    img.style.display = "block";
    lbl.textContent = "Foto cargada correctamente";
  } else {
    img.src = "";
    img.style.display = "none";
    lbl.textContent = "Sin foto cargada";
  }
}

async function cargarOperador() {
  const numero = document.getElementById("operadoresGuardados").value;
  if (!numero) return;
  operadores = await leerDeIndexedDB("matrizILUO") || [];
  operadorActual = operadores.find(o => o.numero === numero);
  if (!operadorActual) {
    showNotification('Operador no encontrado', 'error');
    return;
  }
  mostrarFotoBase64();
  renderizarMatriz();
  setTimeout(() => {
    if (!operadorActual.documentacion) return;
    operadorActual.documentacion.forEach((doc, i) => {
      const id = `doc_${i}`;
      const cal = document.getElementById(`cal_${id}`);
      const nivel = document.getElementById(`nivel_${id}`);
      const fecha = document.getElementById(`fecha_${id}`);

      if (cal)   cal.value   = doc.calificacion || '';
      if (fecha) fecha.value = doc.fecha || '';

      if (cal && nivel) actualizarNivel(id);
    });
    calcularResumenCategorias();
  }, 100);

  showNotification(`Operador ${operadorActual.nombre} cargado`, 'success');
}

async function exportarDatos() {
  const data = {
    matrizILUO: await leerDeIndexedDB("matrizILUO") || [],
    documentosILUO: await leerDeIndexedDB("documentosILUO") || [],
    indiceDocumentosExtra: await leerDeIndexedDB("indiceDocumentosExtra") || [],
    documentosAdministrador: await leerDeIndexedDB("documentosAdministrador") || [],
    indiceIATF: await leerDeIndexedDB("indiceIATF") || [],
    examenesILUO: await leerDeIndexedDB("examenesILUO") || [],
    rutasExamenes: await leerDeIndexedDB(RUTAS_EXAMENES_KEY) || {}
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "respaldo_matriz_iluo_completo.json";
  a.click();
  URL.revokeObjectURL(url);
  showNotification('Datos exportados correctamente', 'success');
}

async function importarDatos(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.matrizILUO) await guardarEnIndexedDB("matrizILUO", data.matrizILUO);
      if (data.documentosILUO) await guardarEnIndexedDB("documentosILUO", data.documentosILUO);
      if (data.indiceDocumentosExtra) await guardarEnIndexedDB("indiceDocumentosExtra", data.indiceDocumentosExtra);
      if (data.documentosAdministrador) await guardarEnIndexedDB("documentosAdministrador", data.documentosAdministrador);
      if (data.indiceIATF) await guardarEnIndexedDB("indiceIATF", data.indiceIATF);
      if (data.examenesILUO) await guardarEnIndexedDB("examenesILUO", data.examenesILUO);
      if (data.rutasExamenes) await guardarEnIndexedDB(RUTAS_EXAMENES_KEY, data.rutasExamenes);
      showNotification('Datos importados correctamente. Recargue la página para ver los cambios.', 'success');
    } catch (err) {
      showNotification('Error al importar el archivo. Verifique que sea un respaldo válido.', 'error');
    }
  };
  reader.readAsText(file);
}

function calcularResumenCategorias() {
  const categorias = {
    "Normatividad": { pts: 5, valores: [] },
    "Valores": { pts: 5, valores: [] },
    "Seguridad": { pts: 15, valores: [] },
    "Lean": { pts: 15, valores: [] },
    "Calidad": { pts: 30, valores: [] },
    "Eficiencia": { pts: 30, valores: [] },
    "Sin Clasificar": { pts: 0, valores: [] }
  };

  const docs = documentos.filter(d =>
    d.puesto && operadorActual.puesto &&
    d.puesto.toLowerCase() === operadorActual.puesto.toLowerCase()
  );

  if (!operadorActual.documentacion) return;

  operadorActual.documentacion.forEach((doc) => {
    const docRef = docs.find(d => d.codigo === doc.codigo);
    const tipo = docRef?.tipoCategoria || "Sin Clasificar";
    const val = parseFloat(doc.calificacion);
    if (!isNaN(val)) {
      if (!categorias[tipo]) categorias[tipo] = { pts: 0, valores: [] };
      categorias[tipo].valores.push(val);
    }
  });

  let total = 0;
  let resumenHTML = '';

  Object.entries(categorias).forEach(([nombre, { pts, valores }]) => {
    const promedio = valores.length ? valores.reduce((a, b) => a + b, 0) / valores.length : 0;
    const puntos = promedio * pts / 100;
    total += puntos;

    if (pts > 0) {
      resumenHTML += `
        <div class="resumen-linea">
          <span class="resumen-categoria">${nombre}</span>
          <span class="resumen-porcentaje">${promedio.toFixed(1)}%</span>
        </div>
      `;
    }
  });

  let nivelFinal = "", letra = "";
  if (total >= 95) { nivelFinal = "Maestro"; letra = "A"; }
  else if (total >= 90) { nivelFinal = "Experto"; letra = "B"; }
  else if (total >= 80) { nivelFinal = "Competente"; letra = "C"; }
  else if (total >= 70) { nivelFinal = "Semicompetente"; letra = "D"; }
  else if (total >= 50) { nivelFinal = "Entrenamiento"; letra = "E"; }
  else { nivelFinal = "Sin Clasificar"; letra = "-"; }

  document.getElementById("promediosPorCategoria").innerHTML = resumenHTML;
  document.getElementById("resultadoFinal").innerHTML =
    `Resultado: ${total.toFixed(1)}% → ${nivelFinal} (Cat. ${letra})`;
}

function aplicarFiltrosMatriz() {
  const categoria = document.getElementById("filtroCategoria")?.value.toLowerCase() || "";
  const codigo = document.getElementById("filtroCodigo")?.value.toLowerCase() || "";
  const documento = document.getElementById("filtroDocumento")?.value.toLowerCase() || "";
  const filas = document.querySelectorAll("#matriz table tbody tr");
  filas.forEach(fila => {
    const celdaCategoria = fila.cells[2]?.textContent.toLowerCase() || "";
    const celdaCodigo = fila.cells[0]?.textContent.toLowerCase() || "";
    const celdaDocumento = fila.cells[1]?.textContent.toLowerCase() || "";
    const mostrar =
      celdaCategoria.includes(categoria) &&
      celdaCodigo.includes(codigo) &&
      celdaDocumento.includes(documento);
    fila.style.display = mostrar ? "" : "none";
  });
}

function showNotification(message, type) {
  const notification = document.getElementById('notification');
  const notificationText = document.getElementById('notificationText');
  notificationText.textContent = message;
  notification.className = `notification ${type}`;
  notification.classList.add('show');
  setTimeout(() => { notification.classList.remove('show'); }, 3000);
}
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

<script>
/* === Controles de Zoom === */
(function initZoom(){
  const guardado = localStorage.getItem('uiZoom');
  const z = guardado ? parseFloat(guardado) : 1.00; // 100% por defecto
  setZoom(z, false);
})();
function setZoom(factor, persistir = true){
  const z = Math.max(0.70, Math.min(1.50, factor)); // límites 70% - 150%
  document.documentElement.style.setProperty('--ui-zoom', z.toString());
  const etiqueta = document.getElementById('zoomVal');
  if(etiqueta) etiqueta.textContent = Math.round(z*100) + '%';
  if(persistir) localStorage.setItem('uiZoom', z.toString());
}
function ajustarZoom(delta){
  const actual = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ui-zoom')) || 1;
  setZoom(actual + delta);
}
</script>

</body>
</html>
